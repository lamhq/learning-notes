# Data Manipulation with ORM

## Create a Session

```py
from sqlalchemy import create_engine
from sqlalchemy.orm import Session

# an Engine, which the Session will use for connection resources
engine = create_engine("postgresql+psycopg2://scott:tiger@localhost/")

# create session
session = Session(engine)
```

## Insert

```py
squidward = User(name="squidward", fullname="Squidward Tentacles")

session.add(squidward)
session.commit()
```

Note: when `Session.add()` is called, the objects have not been inserted yet until `commit()` is called.

Access the autogenerated primary key value:

```py
squidward.id  # 4
```


## Find one by Primary key

```py
some_squidward = session.get(User, 4)
```

SQLAlchemy maintains a unique instance of a particular Python object per a particular database identity, within the scope of a particular `Session` object.

We can check if an object refers to the same object:

```py
some_squidward is squidward
```


## Find one

```py
item = session\
  .query(User)\
  .filter_by(name="squidward")\
  .one()
```

## Find all

```py
items = session\
  .query(User)\
  .filter_by(name="squidward")\
  .all()
```

## Check if object is modified

```py
squidward.fullname = "Sandy Squirrel"
squidward in session.dirty
```

## Update

```py
squidward = session.get(User, 1)
squidward.fullname = "Sandy Squirrel"
session.commit()
```


## Delete

```py
squidward = session.get(User, 1)
session.delete(squidward)
session.commit()
```


## Closing a Session

```py
session.close()
```


## Execute sql command

```py
with Session(engine) as session:
    result = session.execute(
        text("UPDATE some_table SET y=:y WHERE x=:x"),
        [{"x": 9, "y": 11}, {"x": 13, "y": 15}],
    )
    session.commit()
```
