# AWS Snippets

## Preparations

1. [Set up AWS credentials](../aws/dev-tools/aws-cli.mdx#set-up-aws-credentials) on the machine
2. Create a S3 backend bucket for storing Terraform state
3. Create a DynamoDB table for state locking


## Input variables

```hcl filename="variables.tf"
variable "project" {
  type    = string
  description = "Project name"
}

variable "env" {
  type    = string
  description = "Runtime environment (e.g., dev, prod)"
}

variable "owner" {
  type    = string
  description = "Email of resource owner"
}

variable "region" {
  description = "AWS region where resources will be created"
  type        = string
  default     = "us-central-1"
}

variable "artifact_bucket" {
  description = "S3 bucket for storing project's artifacts (Terraform state, Lambda function code, Lambda layers)"
  type        = string
}
```

Template for `.tfvars` file:
```hcl filename="params.tfvars"
project = ""
env = "dev"
owner = ""
region = ""
artifact_bucket = ""
```


## Provider

```hcl filename="provider.tf"
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
    }

    # provides a data source that can create archives from individual files or collections of files
    # useful for packaging code files to be deployed
    archive = {
      source  = "hashicorp/archive"
      version = "~> 2.4.2"
    }

    # provide resources to generate random values
    # useful for creating unique resource identifiers
    random = {
      source  = "hashicorp/random"
      version = "~> 3.6.0"
    }
  }
}

provider "aws" {
  region = var.region

  default_tags {
    tags = {
      owner = var.owner
      project = var.project
    }
  }
}
```


## Name prefix

Define a prefix for resource's name:
```hcl filename="locals.tf"
locals {
  name_prefix = "${var.project}-${var.env}"
}
```


## Backend

```hcl filename="backend.tf"
terraform {
  backend "s3" {
    bucket = var.artifact_bucket
    key    = "${local.name_prefix}/terraform.tfstate"
    dynamodb_table = aws_dynamodb_table.state_locking_table.name
    encrypt        = true
  }
}

resource "aws_dynamodb_table" "state_locking_table" {
  name           = "${local.name_prefix}-terraform-state-lock"
  billing_mode   = "PROVISIONED"
  read_capacity  = 1
  write_capacity = 1
  hash_key       = "LockID"

  attribute {
    name = "LockID"
    type = "S"
  }
}
```
