# AWS Lambda

## Overview

AWS Lambda lets you run code without provisioning or managing servers. Your application runs on servers that are managed by AWS.

You upload the function code in many supported programming languages. AWS Lambda then runs function code in response to events.

You can also set the required performance, concurrency limits, link directly to event sources, ...

Lambda is an example of Function-as-a-Service.


## Pricing
- No upfront or monthly subscription costs for standard functions.
- Pay per request
- You're billed for the duration of the code execution.
- Free tier of 1,000,000 requests and 400,000 GBs of compute per month.
- Ideal for functions whose execution time is very low (under 100ms)


## Features

- Intergrates with numerous AWS services, including S3, DynamoDB, EventBridge, SQS/SNS, Kinesis.
- Bult-in monitoring. Logging and monitoring using CloudWatch.
- Memory requirement can be set up to **10,240 MB**. CPU scales with memory.
- Support popular programming languages: Python, Golang, Java, Node.js, ...


## Use cases

Data transformation: perform transformation on streaming data (data from Kinesis,...).

File processing: perform processing against a file when it is uploaded to an S3 bucket.

Website backend logic: using Lambda as a microservice
for the business logic of the app. A function can be invoked over HTTPS using Amazon API Gateway.

Processing IoT data: when IoT data is received, Lambda can be used to perform some analysis on the data and store them.

Scheduled tasks.

Using Lambda functions with AWS services as event sources, for example:
- Configure CloudWatch Events to invoke your function on a timer
- Configure Amazon S3 to invoke your function when an object is created
- Generating reports based on DynamoDB item changes (using DynamoDB streams to trigger).

On-demand Lambda function invocation using custom applications (mobile, web apps, clients) and AWS SDKs, AWS Mobile SDKs, and the AWS Mobile SDK for Android.


## When not to use Lambda?

Lambda isn't supposed to be a long running process. Lambda functions are limited to a maximum execution time of 15 minutes.

Constant workloads are also a bad fit (such as an API
receives thousands of requests a second at a constant rate, it's also not taking advantage of scaling of the Lambda service).

Extra large code base. The larger the code base, the longer time to load function's code.

Stateful applications. Lambda functions are stateless, you'll need to store the state externally.


## Anti-patterns

### Monolithic function

Where a Lambda combines a lot of different functionality (such as being responsible for a full e-commerce solution).

**Performance**: it increases the package size of a code base. The function takes longer to load and execute, which can impact performance and cost.

**Security**: difficult to enforce least privilege permissions. A single function handling multiple tasks require more permissions. This can potentially lead to security issues.

**Upgrades**:
- Difficult to change without affecting many code parts.
- Higher risk of introducing errors.
- Complicates deployment process.

**Maintenance**:
- Large codebases are challenging to manage.
- Understanding dependencies and interactions is tough.

**Testing**:
- Complexity hinders easy testing.
- Writing and maintaining tests is cumbersome and time-consuming.

**Best practices**:
create smaller focused functions each responsible for a single specific task.

### Recursion

A Lambda function is unintentionally triggered multiple times due to its own output.

**Best practices**:
Implementing safeguards in your code to check if the event that triggered the function was generated by the function itself.


### Orchestration

When a Lambda function implement complex workflow logic and perform orchestration task.

Complex workflows in a Lambda function make it harder to understand and maintain the code. It ties your Lambda function with other systems, making it difficult to change or upgrade individual components.

Complex workflows typically require retries and error handling, lead to further complexity, increase the chances of bugs.

**Best practices**:
Consider using services like AWSs step functions. This is designed to manage cross service workflows
enabling you to break your logic
into smaller and more manageable pieces
and improving overall maintainability and resilience.


### Chaining

When one lambda function invokes another synchronously. The first function is now waiting for the response from the next in the chain.

Increased latency and increased cost, cause each function invocation
is billed separately and each function is waiting on the next.

Increased potential for failure: one of the functions fails, the whole chain will fail.

**Best practices**:
Consider using asynchronous patterns, using services such as Amazon Event Bridge,
or Simple Queue Service. This can help reduce latency and improve fault tolerance
and make it much easier to maintain and debug your application.


## Concepts

### Lambda Function

The Lambda Function is the definition that will be initialized and called by the Lambda service, including:
- The function code
- Configuration of how to execute the code: RAM, CPU, permissions, ...

### Lambda Service

The Lambda service:
- Initializing and calling Lambda functions
- Handling inputs and outputs

It sits between the world and your code.

## Function Configuration

- **Runtime**: You'll need to pick from an available runtime or bring your own. This is the environment your code will run in.
- **Permissions**: If your Lambda function needs to make an AWS API call, you'll need to attach a role.
- **Networking**: Optionally define the VPC, subnet, and security groups your functions are a part of. If you don't specify networking configurations, your Lambda functions run in an AWS owned VPC with internet access in place.
- **Resources**: Define the amount of available memory allocated to your function. CPU scales with memory.
- **Trigger**: Things can kick off Lambda functions. Common triggers: S3, Kinesis, and EventBridge


## Traffic Shifting

Traffic shifting makes it's possible to implement canary deployments of Lambda functions.

By updating additional version weights on an alias, invocation traffic is routed to the new function versions based on the weight specified.

Detailed CloudWatch metrics for the alias and version can be analyzed during the deployment, or other health checks performed, to ensure that the new version is healthy before proceeding.


## AWS Lambda Power Tuning

AWS Lambda Power Tuning is an open-source tool that helps find the most optimal memory and CPU allocation for your lambda functions.

It runs in your own AWS account, and it supports three optimization strategies: cost, speed, and balanced.

To work with AWS Lambda Power Turning, you provide a Lambda function Amazon Resource Name (ARN) as input. It then invokes that function with multiple power configurations. Then, it analyzes all the execution logs and suggests the best power configuration to minimize cost or maximize performance.

AWS Lambda Power Turning also supports cross-Region invocations, and you can enable parallel execution to generate results in a few seconds.

> For example, the following diagram shows results for two CPU-intensive functions, which become both cheaper and faster with more power.

![](./lambda/images/power-tunning.png)


## AWS Lambda Powertools

AWS Lambda Powertools helps you optimize your Lambda functions and use best practices. 

It's a suite of utilities for AWS Lambda functions that is designed to make it easier to adopt best practices such as tracing, structured logging, custom metrics, idempotency, batching, and more. 


## Reuse execution environment 

An optimization technique is to move certain initialization tasks in your code so they are outside the handler. These tasks can then be reused across invocations (which is also known as execution environment reuse). This reuse saves cost by reducing function run time.

- initialize SDK clients and database connections outside of the function handler
- cache static assets locally in the `/tmp` directory.

To avoid potential data leaks across invocations, donâ€™t use the execution environment to store user data, events, or other information with security implications.


## References

- [AWS Lambda Deep Dive](https://learn.acloud.guru/course/e12e634c-c8bc-4721-ac6b-ea6da2509d49/)